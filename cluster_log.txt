# first attempt at a script using hard-coded parameters and file paths.
# 10000 iterations (with setting to exit if no change for 1000)
# Logging every 20 iterations (a little too frequent) - logfile of best score and a set of factors (500 files)
# On HYDRA
module load libs/bioconductor/2.14/gcc-4.4.7+R-3.1.1
cd $SCRATCH/seqPredict
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N auto10k -b y -pe smp.pe 2 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/predictFromSequence.autoRun.R

# another run using 5 layers instead of one.  #layer 1 is still the target.layer. May just see dilution of signal and slowing of progression
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N Layer5_10k -b y -pe smp.pe 2 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/predictFromSequence.autoRun.5_layer.R


#  awk '{ if($1 == "chr7" && $3 == "transcript") print $0 }' /mnt/genome-shared-data/bcf/genomeIndexes/hg19_GRCh37_random_chrM/annotation/gencode.v19.annotation.gtf > data/hg19.G19.chr7.transcript.gtf
#qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N Layer5_chr7 -b y -pe smp.pe 8 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/predictFromSequence.chr7.R
# failed with core dump "memory not mapped"
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N Layer5_chr7 -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/predictFromSequence.chr7.R

# I added verbose as a parameter to several functions to get more detailed output.
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N Lay5_chr7v -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/predictFromSequence.chr7.verbose.R

# I also re-wrote modifyLayerByBindingFactor.multiHits() to use IRanges and speed up the layer modification, but it didn't make much difference.
# Kept failing even with 16 cores. No error messages despite using try()
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N Lay5_chr7v -b y -pe smp.pe 32 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/predictFromSequence.chr7.verbose.R

# let's try a smaller chromosome
awk '{ if($1 == "chr22" && $3 == "transcript") print $0 }' /mnt/genome-shared-data/bcf/genomeIndexes/hg19_GRCh37_random_chrM/annotation/gencode.v19.annotation.gtf > data/hg19.G19.chr22.transcript.gtf
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N Lay5_chr22v -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/predictFromSequence.chr22.verbose.R


module load libs/bioconductor/2.14/gcc-4.4.7+R-3.1.1
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N Lay5_chr22v -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/pfs.chr22.verbose.R
# I terminated the above job after 500 iters without improvement (4%)
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N Lay5_chr22.1kb -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/pfs.chr22.1kb.verbose.R


# get chrM transcripts for testing
#awk '{ if($1 == "chrM" && $3 == "transcript") print $0 }' /mnt/genome-shared-data/bcf/genomeIndexes/hg19_GRCh37_random_chrM/annotation/gencode.v19.annotation.gtf > data/hg19.G19.chrM.transcript.gtf

# attempt a parallel job:-
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N L5_chr22.par -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/pfs.chr22.1kb.par.R
#  a chr7 job to see how things have improved
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N L5_chr7.par -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/pfs.chr7.1kb.par.R


# create a chr19 job to test new runLayerBinding.
awk '{ if($1 == "chr19" && $3 == "transcript") print $0 }' /mnt/genome-shared-data/bcf/genomeIndexes/hg19_GRCh37_random_chrM/annotation/gencode.v19.annotation.gtf > data/hg19.G19.chr19.transcript.gtf
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N L5_chr19.par -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/pfs.chr19.1kb.par.R
# and another for smaller regions.
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N L5_chr19.400 -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/pfs.chr19.400bp.par.R

# repeat with chr22, incorporate new scoring measures
#qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N L5_chr22.400 -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/pfs.chr22.400bp.par.R

# renamed the script to test different score methods.
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -V -N L5_c22.acc.400 -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/pfs.chr22.400bp.acc.R

# attempting to redirect STDOUT and STDERR to results folder.
# results/pfs_layer5_chr22_400bp_acc
# ppv (precision) favours getting postive hits.
mkdir results/pfs_layer5_chr22_400bp_ppv
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -o $SCRATCH/seqPredict/results/pfs_layer5_chr22_400bp_ppv -e $SCRATCH/seqPredict/results/pfs_layer5_chr22_400bp_ppv -V -N L5_c22.ppv.400 -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/pfs.chr22.400bp.ppv.R


# try tpr (sensitivity or recall) to maximise hits coming back. Predict will mark a lot of the chrom
mkdir results/pfs_layer5_chr22_400bp_tpr
qsub -cwd -m e -M david.gerrard@manchester.ac.uk -o $SCRATCH/seqPredict/results/pfs_layer5_chr22_400bp_tpr -e $SCRATCH/seqPredict/results/pfs_layer5_chr22_400bp_tpr -V -N L5_c22.tpr.400 -b y -pe smp.pe 16 Rscript $SCRATCH/seqPredict/predictfromsequence/scripts/pfs.chr22.400bp.tpr.R
